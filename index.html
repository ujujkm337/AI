<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>AI</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" type="image/png">
    <style>
        :root { --bg-color: #0e1621; --panel-color: #17212b; --button-color: #248bf5; --text-main: #f5f5f5; --sidebar-width: 280px; }
        .mode-pink { --bg-color: #1a0b16; --panel-color: #2d1326; --button-color: #ec4899; }
        .mode-green { --bg-color: #0d1a0d; --panel-color: #162616; --button-color: #4caf50; }
        * { box-sizing: border-box; transition: background 0.2s; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100dvh; width: 100%; background: var(--bg-color); color: var(--text-main); overflow: hidden; display: flex; }

        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; left: calc(-1 * var(--sidebar-width)); width: var(--sidebar-width); height: 100%; background: var(--panel-color); z-index: 200; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.05); transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.open { left: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .new-chat-btn { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; cursor: pointer; font-weight: bold; text-align: center; }
        .chats-container { flex: 1; overflow-y: auto; padding: 10px; position: relative; }
        .chat-entry { padding: 12px; border-radius: 8px; margin-bottom: 4px; cursor: pointer; font-size: 14px; color: rgba(255,255,255,0.6); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-entry.active { background: rgba(255,255,255,0.08); color: var(--button-color); border-left: 3px solid var(--button-color); }
        .load-chat-btn { position: absolute; right: 15px; bottom: 15px; width: 45px; height: 45px; background: var(--button-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.4); font-size: 20px; }

        /* CONTEXT MENU */
        .context-menu { position: fixed; background: #242f3d; border-radius: 12px; padding: 6px 0; min-width: 170px; box-shadow: 0 12px 30px rgba(0,0,0,0.6); z-index: 1000; display: none; border: 1px solid rgba(255,255,255,0.1); }
        .menu-item { padding: 12px 18px; font-size: 14px; color: white; cursor: pointer; }
        .menu-item:hover { background: rgba(255,255,255,0.08); }
        .menu-item.danger { color: #ff595a; }

        /* MAIN */
        .main-container { height: 100%; display: flex; flex-direction: column; width: 100%; position: relative; }
        .header-bar { height: 60px; background: var(--panel-color); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; }
        .menu-icon { font-size: 28px; cursor: pointer; padding: 5px; }
        .switch-box { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 20px; cursor: pointer; }
        .switch { position: relative; width: 54px; height: 28px; background: #3d4b59; border-radius: 20px; }
        .switch-handle { position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .mode-normal .switch-handle { left: 3px; }
        .mode-pink .switch-handle { left: 16px; background: #ec4899; }
        .mode-green .switch-handle { left: 29px; background: #4caf50; }

        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 16px; line-height: 1.5; word-wrap: break-word; position: relative; }
        .msg-ai { background: var(--panel-color); align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg-user { background: var(--button-color); align-self: flex-end; border-bottom-right-radius: 4px; color: white; }

        .input-area { padding: 15px; background: var(--bg-color); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .input-container { flex: 1; background: var(--panel-color); border-radius: 24px; padding: 0 18px; height: 48px; display: flex; align-items: center; }
        input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 16px; width: 100%; }
        #send-btn { width: 48px; height: 48px; background: var(--button-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .stop-sq { width: 16px; height: 16px; background: white; border-radius: 2px; display: none; }
        #send-btn.is-generating .stop-sq { display: block; }
        #send-btn.is-generating svg { display: none; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 150; backdrop-filter: blur(4px); }
        .sidebar-overlay.open { display: block; }
    </style>
</head>
<body id="body-tag" class="mode-normal">
    <div id="ctx-menu" class="context-menu"></div>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header"><div class="new-chat-btn" onclick="startNewChat()">+ –ù–æ–≤—ã–π —á–∞—Ç</div></div>
        <div class="chats-container" id="chats-list"></div>
        <div class="load-chat-btn" onclick="document.getElementById('file-input').click()">üìÇ</div>
        <input type="file" id="file-input" style="display:none" onchange="loadChatFromFile(event)">
    </div>

    <div class="main-container">
        <div class="header-bar">
            <div class="menu-icon" onclick="toggleSidebar()">‚â°</div>
            <div class="switch-box" onclick="cycleMode()">
                <span id="mode-icon">üõ°Ô∏è</span>
                <div class="switch"><div class="switch-handle"></div></div>
            </div>
        </div>
        <div id="chat-window">
            <div class="msg msg-ai" id="status-msg">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –ó–∞–ø—É—Å—Ç–∏ Termux –∏ –ø–∏—à–∏!</div>
        </div>
        <div class="input-area">
            <div class="input-container"><input type="text" id="user-input" placeholder="–°–ø—Ä–æ—Å–∏ –æ —á–µ–º —É–≥–æ–¥–Ω–æ..." autocomplete="off"></div>
            <button id="send-btn" onclick="handleAction()">
                <div class="stop-sq"></div>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>

    <script>
        let modeIndex = 0, controller = null, currentChatId = Date.now(), currentAiBuffer = "";
        let allChats = JSON.parse(localStorage.getItem('ai_v9_data')) || {};

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('open'); }
        function cycleMode() {
            modeIndex = (modeIndex + 1) % 3;
            const body = document.getElementById('body-tag'), icon = document.getElementById('mode-icon');
            body.className = modeIndex === 0 ? 'mode-normal' : modeIndex === 1 ? 'mode-pink' : 'mode-green';
            icon.textContent = modeIndex === 0 ? "üõ°Ô∏è" : modeIndex === 1 ? "üå∏" : "üåø";
        }

        const ctx = document.getElementById('ctx-menu');
        window.onclick = () => ctx.style.display = 'none';

        function showCtx(e, type, id, el) {
            e.preventDefault();
            const x = e.pageX || e.touches[0].pageX;
            const y = e.pageY || e.touches[0].pageY;
            if(type === 'chat') {
                ctx.innerHTML = `<div class="menu-item" onclick="saveChatToFile('${id}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</div><div class="menu-item danger" onclick="deleteChat('${id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>`;
            } else {
                ctx.innerHTML = `<div class="menu-item" onclick="copyText('${el.innerText}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div><div class="menu-item" onclick="editMsg('${el.id}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</div>`;
                ctx.targetId = el.id;
            }
            ctx.style.display = 'block'; ctx.style.left = x + 'px'; ctx.style.top = (y - 40) + 'px';
        }

        function setupLong(element, callback) {
            let t;
            const start = (e) => t = setTimeout(() => callback(e), 600);
            const stop = () => clearTimeout(t);
            ['mousedown', 'touchstart'].forEach(ev => element.addEventListener(ev, start));
            ['mouseup', 'mouseleave', 'touchend'].forEach(ev => element.addEventListener(ev, stop));
        }

        function copyText(t) { navigator.clipboard.writeText(t); }
        function editMsg(id) { const el = document.getElementById(id); const n = prompt("–ü—Ä–∞–≤–∫–∞:", el.innerText); if(n) { el.innerText = n; saveAll(); }}
        function deleteChat(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { delete allChats[id]; saveAll(); renderChatsList(); startNewChat(); }}
        function saveChatToFile(id) { 
            const blob = new Blob([JSON.stringify(allChats[id])], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `chat_${id}.json`; a.click();
        }
        function loadChatFromFile(e) {
            const reader = new FileReader(); reader.onload = (ev) => {
                const c = JSON.parse(ev.target.result); const nid = Date.now();
                allChats[nid] = c; saveAll(); renderChatsList(); loadChat(nid);
            }; reader.readAsText(e.target.files[0]);
        }
        function saveAll() { localStorage.setItem('ai_v9_data', JSON.stringify(allChats)); }

        function renderChatsList() {
            const list = document.getElementById('chats-list'); list.innerHTML = '';
            Object.keys(allChats).sort((a,b) => b-a).forEach(id => {
                const e = document.createElement('div'); e.className = `chat-entry ${id == currentChatId ? 'active' : ''}`;
                e.innerText = allChats[id].title || '–ß–∞—Ç'; e.onclick = () => loadChat(id);
                setupLong(e, (ev) => showCtx(ev, 'chat', id)); list.appendChild(e);
            });
        }

        function loadChat(id) {
            currentChatId = id; const win = document.getElementById('chat-window'); win.innerHTML = '';
            allChats[id].messages.forEach((m, i) => {
                const d = document.createElement('div'); d.id = 'msg-'+id+'-'+i;
                d.className = `msg msg-${m.role === 'user' ? 'user' : 'ai'}`; d.innerText = m.text;
                setupLong(d, (ev) => showCtx(ev, 'msg', null, d)); win.appendChild(d);
            });
            renderChatsList(); if(window.innerWidth < 768) toggleSidebar(); win.scrollTop = win.scrollHeight;
        }

        function startNewChat() { currentChatId = Date.now(); document.getElementById('chat-window').innerHTML = ''; renderChatsList(); }

        async function handleAction() {
            const btn = document.getElementById('send-btn'), input = document.getElementById('user-input');
            if (btn.classList.contains('is-generating')) {
                if (controller) { 
                    controller.abort(); 
                    if (allChats[currentChatId]) allChats[currentChatId].messages.push({ role: 'assistant', text: currentAiBuffer + " [–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ]" }); 
                    saveAll();
                }
                return;
            }
            const text = input.value.trim(); if (!text) return;
            input.value = ''; btn.classList.add('is-generating'); controller = new AbortController(); currentAiBuffer = "";
            const win = document.getElementById('chat-window');
            win.innerHTML += `<div class="msg msg-user">${text}</div>`;
            const aiDiv = document.createElement('div'); aiDiv.className = 'msg msg-ai'; aiDiv.innerText = "–î—É–º–∞—é..."; win.appendChild(aiDiv); win.scrollTop = win.scrollHeight;

            if (!allChats[currentChatId]) allChats[currentChatId] = { title: text.substring(0, 20), messages: [] };
            let history = allChats[currentChatId].messages.slice(-6).map(m => `<|im_start|>${m.role}\n${m.text}<|im_end|>`).join('\n');
            const prompt = `<|im_start|>system\n–¢—ã AI. –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ.<|im_end|>\n${history}\n<|im_start|>user\n${text}<|im_end|>\n<|im_start|>assistant\n`;

            try {
                // –í–ê–ñ–ù–û: –∞–¥—Ä–µ—Å 127.0.0.1 –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∞–π—Ç—É –≤–∏–¥–µ—Ç—å —Å–µ—Ä–≤–µ—Ä –≤ Termux
                const response = await fetch('http://127.0.0.1:8080/completion', { 
                    method: 'POST', 
                    signal: controller.signal, 
                    body: JSON.stringify({ prompt, n_predict: 1000, stream: true, stop: ["<|im_end|>"] }) 
                });
                const reader = response.body.getReader(), decoder = new TextDecoder();
                aiDiv.innerText = "";
                while (true) {
                    const { done, value } = await reader.read(); if (done) break;
                    const chunks = decoder.decode(value).split('\n');
                    for (const chunk of chunks) {
                        if (chunk.startsWith('data: ')) {
                            const c = JSON.parse(chunk.slice(6)).content;
                            currentAiBuffer += c; aiDiv.innerText = currentAiBuffer; win.scrollTop = win.scrollHeight;
                        }
                    }
                }
                allChats[currentChatId].messages.push({role: 'user', text}, {role: 'assistant', text: currentAiBuffer});
                saveAll(); renderChatsList();
            } catch (e) {
                if (e.name === 'AbortError') aiDiv.innerText = currentAiBuffer + " [–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ]";
                else aiDiv.innerText = "–û—à–∏–±–∫–∞: –î–≤–∏–∂–æ–∫ –Ω–µ –∑–∞–ø—É—â–µ–Ω! –ó–∞–ø—É—Å—Ç–∏ ./start.sh –≤ Termux.";
            }
            btn.classList.remove('is-generating'); controller = null;
        }

        renderChatsList();
        document.getElementById('user-input').onkeydown = (e) => { if(e.key === 'Enter') handleAction(); };
    </script>
</body>
</html>
