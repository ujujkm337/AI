#!/bin/bash

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –ª–æ–∫–∞–ª—å–Ω–æ–π –Ω–µ–π—Ä–æ–Ω–∫–∏..."

# 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –∏ —Å—Ç–∞–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pkg update && pkg upgrade -y
pkg install clang cmake make git python curl -y

# 2. –°–∫–∞—á–∏–≤–∞–µ–º –∏ —Å–æ–±–∏—Ä–∞–µ–º –¥–≤–∏–∂–æ–∫ llama.cpp
if [ ! -d "llama.cpp" ]; then
    echo "üì¶ –ö–ª–æ–Ω–∏—Ä—É—é llama.cpp..."
    git clone https://github.com/ggerganov/llama.cpp
    cd llama.cpp
    echo "üõ†Ô∏è –°–æ–±–∏—Ä–∞—é –¥–≤–∏–∂–æ–∫ (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-5 –º–∏–Ω—É—Ç)..."
    mkdir build
    cd build
    cmake ..
    cmake --build . --config Release -j$(nproc)
    cd ../..
else
    echo "‚úÖ –î–≤–∏–∂–æ–∫ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
fi

# 3. –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –º–æ–¥–µ–ª–µ–π
mkdir -p models

# 4. –°–∫–∞—á–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å Qwen 1.5B (–æ–Ω–∞ –ª–µ–≥–∫–∞—è, –±—ã—Å—Ç—Ä–∞—è –∏ —É–º–Ω–∞—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤)
if [ ! -f "models/model.gguf" ]; then
    echo "üß† –°–∫–∞—á–∏–≤–∞—é –º–æ–∑–≥ –Ω–µ–π—Ä–æ–Ω–∫–∏ (–º–æ–¥–µ–ª—å Qwen 1.5B)..."
    # –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ GGUF
    curl -L https://huggingface.co/Qwen/Qwen2.5-1.5B-Instruct-GGUF/resolve/main/qwen2.5-1.5b-instruct-q4_k_m.gguf -o models/model.gguf
else
    echo "‚úÖ –ú–æ–¥–µ–ª—å —É–∂–µ –Ω–∞ –º–µ—Å—Ç–µ."
fi

# 5. –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
echo "üìù –°–æ–∑–¥–∞—é —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫–∞ start.sh..."
cat <<EOF > start.sh
#!/bin/bash
# –ó–∞—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
./llama.cpp/build/bin/llama-server \
  -m models/model.gguf \
  --port 8080 \
  --host 0.0.0.0 \
  -c 2048 \
  --threads 4 \
  --cont-batching
EOF

# –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø—É—Å–∫
chmod +x start.sh

echo ""
echo "-------------------------------------------------------"
echo "üéâ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "-------------------------------------------------------"
echo "–ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ–π—Ä–æ–Ω–∫—É, –≤–≤–µ–¥–∏ –∫–æ–º–∞–Ω–¥—É:"
echo "   ./start.sh"
echo ""
echo "–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π Termux –∏ –æ—Ç–∫—Ä—ã–≤–∞–π —Å–≤–æ–π"
echo "index.html (–Ω–∞ GitHub Pages –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ)."
echo "-------------------------------------------------------"
